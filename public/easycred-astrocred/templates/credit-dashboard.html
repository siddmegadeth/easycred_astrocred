<!-- Premium Credit Report Dashboard -->
<div class="credit-dashboard">
    
    <!-- Loading State -->
    <div class="loading-overlay" ng-if="isLoading">
        <div class="loading-spinner">
            <div class="spinner-border" role="status"></div>
            <p>Analyzing your credit report with AI...</p>
        </div>
    </div>

    <!-- Upload Success Toast -->
    <div class="upload-toast" ng-if="uploadedFileName">
        <i class="fas fa-check-circle"></i>
        <span>Loaded: <strong>{{uploadedFileName}}</strong></span>
    </div>

    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-7 col-md-6">
                    <h1 class="dashboard-title">
                        <i class="fas fa-chart-line"></i> Credit Health Dashboard
                    </h1>
                    <p class="dashboard-subtitle">AI-Powered Credit Analysis & Predictions</p>
                </div>
                <div class="col-lg-5 col-md-6 text-md-end mt-3 mt-md-0">
                    <label class="btn btn-warning me-2" for="jsonUpload">
                        <i class="fas fa-upload"></i> Upload JSON
                    </label>
                    <input type="file" id="jsonUpload" accept=".json" style="display:none" 
                           onchange="angular.element(this).scope().handleFileUpload(this.files[0])">
                    <button class="btn btn-light me-2" ng-click="downloadPDF()" ng-disabled="!creditData">
                        <i class="fas fa-file-pdf"></i> Report
                    </button>
                    <button class="btn btn-outline-light" ng-click="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content - With Data -->
    <div class="container dashboard-content" ng-if="creditData">
        
        <!-- Row 1: Score Overview -->
        <div class="row">
            <!-- Credit Score Gauge -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="dashboard-card score-card">
                    <div class="card-header">
                        <h5><i class="fas fa-tachometer-alt"></i> Credit Score</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="score-gauge">
                            <svg viewBox="0 0 200 120" class="gauge-svg">
                                <defs>
                                    <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#ef4444"/>
                                        <stop offset="30%" style="stop-color:#f59e0b"/>
                                        <stop offset="70%" style="stop-color:#10b981"/>
                                        <stop offset="100%" style="stop-color:#06b6d4"/>
                                    </linearGradient>
                                </defs>
                                <path class="gauge-arc-bg" d="M 20 100 A 80 80 0 0 1 180 100"/>
                                <path class="gauge-arc-fill" d="M 20 100 A 80 80 0 0 1 180 100"
                                      ng-attr-stroke-dasharray="{{getScoreArc()}} 251"
                                      stroke-dashoffset="0"/>
                            </svg>
                        </div>
                        <div class="score-value">{{creditData.credit_score}}<span class="score-max">/900</span></div>
                        <div class="score-label" ng-class="getScoreClass()">{{getScoreLabel()}}</div>
                    </div>
                </div>
            </div>

            <!-- Grade Circle -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="dashboard-card grade-card">
                    <div class="card-header">
                        <h5><i class="fas fa-award"></i> Credit Grade</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="grade-circle">
                            <span>{{creditData.overallGrade?.grade || 'B'}}</span>
                        </div>
                        <div class="grade-description">{{getGradeDescription()}}</div>
                    </div>
                </div>
            </div>

            <!-- Risk Level -->
            <div class="col-lg-4 col-md-12 mb-4">
                <div class="dashboard-card risk-card" ng-class="getRiskClass()">
                    <div class="card-header">
                        <h5><i class="fas fa-shield-alt"></i> Risk Assessment</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="risk-indicator" ng-class="getRiskClass()">
                            <i class="fas" ng-class="getRiskIcon()"></i>
                        </div>
                        <div class="risk-label" ng-class="getRiskClass()">{{getRiskLabel()}}</div>
                        <div class="risk-probability" ng-class="getRiskClass()">
                            {{creditData.default_probability || 70}}%
                        </div>
                        <div style="color: var(--muted); font-size: 0.9rem; margin-top: 5px;">Default Probability</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Profile & Quick Stats -->
        <div class="row">
            <!-- Profile Information -->
            <div class="col-lg-6 mb-4">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-user-circle"></i> Profile Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span class="info-label">Full Name</span>
                            <span class="info-value">{{creditData.name}}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Client ID</span>
                            <span class="info-value" style="font-family: 'JetBrains Mono'; font-size: 0.85rem;">{{creditData.client_id | limitTo:30}}...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Report Date</span>
                            <span class="info-value">{{reportDate | date:'dd MMM yyyy'}}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Credit Bureau</span>
                            <span class="info-value">TransUnion CIBIL</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Report Status</span>
                            <span class="info-value" style="color: var(--success-light);">
                                <i class="fas fa-check-circle"></i> Active
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats Grid -->
            <div class="col-lg-6 mb-4">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Credit Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value">{{creditData.report?.summary?.totalAccounts || getTotalAccounts()}}</span>
                                <span class="stat-label">Total Accounts</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value warning">{{creditData.report?.summary?.totalEnquiries || getTotalEnquiries()}}</span>
                                <span class="stat-label">Credit Enquiries</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" ng-class="getUtilizationClass()">
                                    {{(creditData.report?.summary?.creditUtilization || getCreditUtilization()) | number:0}}%
                                </span>
                                <span class="stat-label">Credit Utilization</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value danger">{{getAtRiskAccounts()}}</span>
                                <span class="stat-label">At Risk Accounts</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Payment History -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Payment History Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-history-bar">
                            <div class="payment-bar-segment ontime" 
                                 ng-style="{'width': getPaymentPercent('onTime') + '%'}"></div>
                            <div class="payment-bar-segment delayed" 
                                 ng-style="{'width': getPaymentPercent('delayed') + '%'}"></div>
                            <div class="payment-bar-segment missed" 
                                 ng-style="{'width': getPaymentPercent('missed') + '%'}"></div>
                        </div>
                        <div class="payment-legend">
                            <div class="legend-item">
                                <span class="legend-dot ontime"></span>
                                <span>On Time ({{getPaymentCount('onTime')}})</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot delayed"></span>
                                <span>Delayed ({{getPaymentCount('delayed')}})</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot missed"></span>
                                <span>Missed ({{getPaymentCount('missed')}})</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: ML Predictions (Enhanced) -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="dashboard-card ml-section">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-brain"></i> AI Score Predictions (6 Months)</h5>
                        <button class="btn btn-sm btn-outline-light" ng-click="refreshMLPredictions()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="prediction-timeline">
                                    <div class="prediction-month" ng-repeat="pred in mlPredictions.predictions">
                                        <div class="month-label">Month {{$index + 1}}</div>
                                        <div class="predicted-score">
                                            {{pred.score}}
                                            <span class="score-change" ng-if="pred.change > 0">+{{pred.change}}</span>
                                        </div>
                                        <div class="confidence">{{pred.confidence}}% confidence</div>
                                    </div>
                                </div>
                                <div class="final-prediction">
                                    <div class="final-score">{{mlPredictions.targetScore || 701}}</div>
                                    <div class="final-label">Potential Score in 6 Months</div>
                                </div>
                            </div>
                            <div class="col-lg-4 mt-4 mt-lg-0">
                                <h5 style="color: var(--primary-light); margin-bottom: 16px;">
                                    <i class="fas fa-lightbulb"></i> AI Recommendations
                                </h5>
                                <div class="ai-recommendations">
                                    <div class="ai-tip" ng-repeat="tip in mlPredictions.recommendations | limitTo:4">
                                        <div class="ai-tip-icon" ng-class="tip.priority || 'medium'">
                                            <i class="fas" ng-class="tip.icon || 'fa-info-circle'"></i>
                                        </div>
                                        <div class="ai-tip-content">
                                            <h6>{{tip.title}}</h6>
                                            <p>{{tip.description}}</p>
                                            <div class="ai-tip-impact" ng-if="tip.impact">
                                                <i class="fas fa-arrow-up"></i> {{tip.impact}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 5: Bank Suggestions -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-university"></i> Recommended Financial Institutions</h5>
                    </div>
                    <div class="card-body">
                        <div class="bank-suggestions-grid">
                            <div class="bank-card" ng-repeat="bank in creditData.bankSuggestions | limitTo:6">
                                <div class="bank-icon">
                                    <i class="fas fa-landmark"></i>
                                </div>
                                <div class="bank-name">{{bank.name}}</div>
                                <div class="bank-products">
                                    <span class="product-tag" ng-repeat="product in bank.loanTypes | limitTo:2">
                                        {{product}}
                                    </span>
                                </div>
                                <div class="bank-approval">{{bank.probability}}% Approval</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 6: Accounts Table -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-exclamation-triangle"></i> Accounts Requiring Attention</h5>
                        <span style="color: var(--muted); font-size: 0.85rem;">
                            {{getAtRiskAccounts()}} accounts at risk
                        </span>
                    </div>
                    <div class="card-body" style="padding: 0; overflow-x: auto;">
                        <table class="accounts-table">
                            <thead>
                                <tr>
                                    <th>Lender</th>
                                    <th>Account Type</th>
                                    <th>Credit Limit</th>
                                    <th>Current Balance</th>
                                    <th>Overdue</th>
                                    <th>Utilization</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="account in getHighUtilizationAccounts() | limitTo:10">
                                    <td><strong>{{account.lender}}</strong></td>
                                    <td>{{account.type}}</td>
                                    <td>₹{{account.limit | number:0}}</td>
                                    <td>₹{{account.balance | number:0}}</td>
                                    <td style="color: var(--danger-light);">₹{{account.overdue | number:0}}</td>
                                    <td>
                                        <div class="utilization-bar">
                                            <div class="utilization-fill" 
                                                 ng-class="getUtilizationBarClass(account.utilization)"
                                                 ng-style="{'width': account.utilization + '%'}"></div>
                                        </div>
                                        <span style="font-size: 0.8rem; margin-left: 8px;">{{account.utilization}}%</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 7: Improvement Plan -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-rocket"></i> 6-Month Improvement Plan</h5>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 24px;">
                            <div class="grade-circle" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                <span>{{creditData.overallGrade?.grade || 'B'}}</span>
                            </div>
                            <i class="fas fa-arrow-right" style="font-size: 1.5rem; color: var(--muted);"></i>
                            <div class="grade-circle" style="width: 60px; height: 60px; font-size: 1.5rem; background: var(--success);">
                                <span>{{creditData.plan?.targetGrade || 'A'}}</span>
                            </div>
                        </div>
                        <div class="improvement-timeline">
                            <div class="timeline-item" ng-repeat="month in creditData.plan?.monthlyActions | limitTo:4">
                                <div class="timeline-month">Month {{month.month}}</div>
                                <div class="timeline-action" ng-repeat="action in month.actions | limitTo:1">
                                    {{action}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loan Calculator -->
            <div class="col-lg-6 mb-4">
                <div class="dashboard-card loan-calculator">
                    <div class="card-header">
                        <h5><i class="fas fa-calculator"></i> Loan Approval Probability</h5>
                    </div>
                    <div class="card-body">
                        <div class="loan-form-row">
                            <div class="loan-form-group">
                                <label>Loan Type</label>
                                <select ng-model="loanCalc.type">
                                    <option value="personal">Personal Loan</option>
                                    <option value="home">Home Loan</option>
                                    <option value="auto">Auto Loan</option>
                                    <option value="gold">Gold Loan</option>
                                </select>
                            </div>
                            <div class="loan-form-group">
                                <label>Loan Amount (₹)</label>
                                <input type="number" ng-model="loanCalc.amount" placeholder="100000">
                            </div>
                            <div class="loan-form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn-calculate" ng-click="calculateLoanProbability()">
                                    <i class="fas fa-calculator"></i> Calculate
                                </button>
                            </div>
                        </div>
                        <div class="loan-result" ng-if="loanProbability">
                            <div class="result-item approval">
                                <div class="result-value">{{loanProbability.approval}}%</div>
                                <div class="result-label">Approval Chance</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value" style="color: var(--primary-light);">{{loanProbability.rate}}%</div>
                                <div class="result-label">Est. Interest Rate</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value" style="color: #f1f5f9;">₹{{loanProbability.emi | number:0}}</div>
                                <div class="result-label">Est. Monthly EMI</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 8: Economic Indicators -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-globe"></i> Economic Indicators</h5>
                        <span style="color: var(--muted); font-size: 0.85rem;">
                            Updated: {{reportDate | date:'dd MMM yyyy'}}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="economic-grid">
                            <div class="economic-item">
                                <div class="economic-value">6.5%</div>
                                <div class="economic-label">GDP Growth</div>
                            </div>
                            <div class="economic-item">
                                <div class="economic-value" style="color: #fbbf24;">1.55%</div>
                                <div class="economic-label">Inflation</div>
                            </div>
                            <div class="economic-item">
                                <div class="economic-value">5.5%</div>
                                <div class="economic-label">Repo Rate</div>
                            </div>
                            <div class="economic-item">
                                <div class="economic-value" style="color: var(--danger-light);">7.3%</div>
                                <div class="economic-label">Unemployment</div>
                            </div>
                            <div class="economic-item">
                                <div class="economic-value" style="color: var(--success-light);">75</div>
                                <div class="economic-label">Market Sentiment</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- No Data State -->
    <div class="container dashboard-content" ng-if="!creditData && !isLoading">
        <div class="no-data-state">
            <div class="icon-wrapper">
                <i class="fas fa-chart-pie"></i>
            </div>
            <h3>No Credit Data Available</h3>
            <p>Upload your CIBIL report or select a sample file to get started</p>
            
            <div class="sample-files-section">
                <h5><i class="fas fa-folder-open"></i> Load Sample Data</h5>
                <div class="row justify-content-center">
                    <div class="col-md-4 mb-3">
                        <select class="form-select" ng-model="selectedSampleFile" ng-change="loadSelectedSample()">
                            <option value="">-- Select Sample File --</option>
                            <option ng-repeat="file in sampleFiles" value="{{file.name}}">{{file.name}}</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <button class="btn btn-secondary w-100" ng-click="loadSampleData()">
                            <i class="fas fa-database"></i> Default
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="btn btn-warning w-100" for="jsonUploadEmpty">
                            <i class="fas fa-upload"></i> Upload JSON
                        </label>
                        <input type="file" id="jsonUploadEmpty" accept=".json" style="display:none"
                               onchange="angular.element(this).scope().handleFileUpload(this.files[0])">
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
